#include <stdio.h> 
#include <ctype.h>
#include <stdlib.h> 
#include <string.h> 
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/shm.h>
#include <signal.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <arpa/inet.h>
#include <fcntl.h>
#include <errno.h>
#include <time.h>
#include <termio.h>
#include <sys/wait.h>

/*
#include "./include/sqlite3.h"
#include "./include/M2MManager.h"
#include "./include/configRW.h"
#include "./include/writeLog.h"
#include "./include/TCPSocket.h"
 */
#include "./include/iDCU.h"

#include "./driver/include/PLCS_9.h"
#include "./driver/include/PLCS_10.h"
#include "./driver/include/PLCS_12.h"
#include "./driver/include/PLCS_12ex.h"
#include "./driver/include/iDCU_IoT.h"
#include "./driver/include/GN1200.h"

#include "./include/libpointparser.h"
#include "./include/libDeviceInfoParser.h"


static void sig_handler( int signo);
static void createDriver( DEVICEINFO *device, TAGINFO *tag );
static void createProcess( pid_t *pid, DEVICEINFO *device, TAGINFO *tag );


static void createDriver( DEVICEINFO *device, TAGINFO *tag )
{

    writeLogV2("/work/smart/comm/log/deviceLog", "[Start]", "[%s][%d] Open", device->driver, (int)getpid() );
    if (strcmp(device->driver,"PLCS9") == 0) 
    {
	PLCS9(device);
    }
    else if (strcmp(device->driver,"PLCS10") == 0) 
    {
	PLCS10(device);
    }
    else if (strcmp(device->driver,"PLCS12") == 0) 
    {
	PLCS12(device);
    }
    else if (strcmp(device->driver,"PLCS12ex") == 0) 
    {
	PLCS12ex(device);
    }
    else if (strcmp(device->driver,"iDCU_IoT") == 0) 
    {
	iDCU_IoT(device);
    }
    else if (strcmp(device->driver,"GN1200") == 0) 
    {
	GN1200(device);
    }
    else
	printf("no exist~~~~~~\n");

}


int main(int argc, char **argv) { 

    int i;
    int threadCount = 0;
    int status;
    NODEINFO xmlinfo;
    pid_t pidCheck;
    //xmlinfo = pointparser("/work/smart/device_info.xml");
    xmlinfo = deviceInfoParser("/work/smart/device_info.xml");

    signal( SIGINT, (void *)sig_handler);

    pid_t pids[xmlinfo.getPointSize];
    printf("xmlinfo.getPointSize %d\n", xmlinfo.getPointSize);

    for( i = 0; i < xmlinfo.getPointSize; i++ )
    {
	createProcess( &pids[i], &xmlinfo.device[i], &xmlinfo.tag[i] );
	usleep(100000);	// 100ms
    }

    writeLog("/work/smart/log", "[CommunicationManager] start CommunicationManager.o" );

    while(1)
    {

	for( i = 0; i < xmlinfo.getPointSize; i++ )
	{
	    pidCheck = waitpid( pids[i], &status, WNOHANG );
	    if( 0 != pidCheck )
	    {

		printf("[%s][%d] exit\n", xmlinfo.device[i].driver, pids[i] );
		writeLogV2("/work/smart/comm/log/deviceLog", "[Error]", "[%s][%d] exit", xmlinfo.device[i].driver, pids[i] );

		createProcess( &pids[i], &xmlinfo.device[i], &xmlinfo.tag[i] );
	    }

	    pidCheck = 0;
	    status = 0;
	    usleep(100000);	// 100ms
	}
	sleep(1);
    }	

    return 0; 
} 

static void createProcess( pid_t *pid, DEVICEINFO *device, TAGINFO *tag )
{

    *pid = fork();
    printf("[%s] *pid %d\n", device->driver, *pid);

    if( *pid < 0 )
    {
	perror("fork error : ");
	writeLogV2("/work/smart/comm/log/deviceLog", "[Error]", "[%s] error fork()", device->driver );
    }

    if( *pid == 0 )
    {
	printf("My pid %d\n", (int)getpid() );
	createDriver( device, tag );
	exit(0);
    }
    else
    {
	printf("Parent %d, child %d\n", (int)getpid(), *pid );
    }

}

static void sig_handler( int signo)
{
    int i;
    int rc;
    int status;

    printf("[%d] return Code %d\n", (int)getpid(), signo);
    writeLogV2("/work/smart/comm/log/deviceLog", "[Error]", "[%d] return Code %d", (int)getpid(), signo );

    exit(1);
}
